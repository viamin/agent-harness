name: Update release-please lockfile

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-please-lockfile-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  update-lockfile:
    if: >-
      github.event.pull_request.head.repo.full_name == github.repository &&
      startsWith(github.event.pull_request.head.ref, 'release-please--')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@90be1154f987f4dc0fe0dd0feedac9e473aa4ba8
        with:
          ruby-version: "3.3"
          bundler: 4.0.3

      - name: Update lockfile checksums
        env:
          BUNDLE_FROZEN: "false"
          BUNDLE_DEPLOYMENT: "false"
        run: bundle _4.0.3_ lock --add-checksums

      - name: Commit lockfile if changed
        run: |
          if git status --porcelain Gemfile.lock | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add Gemfile.lock
            git commit -m "chore: update Gemfile.lock"
            git push
          else
            echo "Gemfile.lock unchanged"
          fi
